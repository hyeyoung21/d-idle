apiVersion: apps/v1
kind: Deployment
metadata:
  name: didle-app
  labels:
    app: didle-app
spec:
  progressDeadlineSeconds: 900  # 15ë¶„ìœ¼ë¡œ í™•ì¥
  replicas: 1  # í”„ë¦¬í‹°ì–´ì—ì„œëŠ” 1ê°œë¡œ ì œí•œ
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1       # ìµœëŒ€ ì¶”ê°€ ìƒì„± í—ˆìš© Pod ìˆ˜
      maxUnavailable: 0  # ì—…ë°ì´íŠ¸ ì¤‘ ë‹¤ìš´ í—ˆìš© Pod ìˆ˜
  selector:
    matchLabels:
      app: didle-app
  template:
    metadata:
      labels:
        app: didle-app
    spec:
      imagePullSecrets:
        - name: ecr-secret
      containers:
        - name: didle-app
          image: {{ECR_URI}}:{{TAG}}  # ğŸ‘ˆ ì´ ë¶€ë¶„ ìˆ˜ì •
          imagePullPolicy: IfNotPresent  # í”„ë¦¬í‹°ì–´ íŠ¸ë˜í”½ ì ˆì•½
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: "prod"
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: db-secrets
                  key: jdbc-url
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-secrets
                  key: db-password
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 45  # í”„ë¦¬í‹°ì–´ ì„±ëŠ¥ ê³ ë ¤
            periodSeconds: 15
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 20
            failureThreshold: 3
          resources:
            requests:  # ìµœì†Œ ìš”ì²­ëŸ‰ (í”„ë¦¬í‹°ì–´ ìµœì í™”)
              memory: "256Mi"
              cpu: "250m"
            limits:    # ìµœëŒ€ í•œë„ (ê³¼ê¸ˆ ë°©ì§€)
              memory: "512Mi"
              cpu: "500m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
