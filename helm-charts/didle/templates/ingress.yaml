# ingress.yaml 수정본 (values.yaml 수정본과 함께 사용)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ .Release.Name }}-ingress
  annotations:
    alb.ingress.kubernetes.io/scheme: {{ .Values.ingress.annotations.alb\.ingress\.kubernetes\.io/scheme }} # '.' 이스케이프 또는 다른 구조 사용 권장
    alb.ingress.kubernetes.io/target-type: {{ .Values.ingress.annotations.alb\.ingress\.kubernetes\.io/target-type }}
    external-dns.alpha.kubernetes.io/hostname: {{ .Values.ingress.annotations.external-dns\.alpha\.kubernetes\.io/hostname }}
    # ALB 인증서 ARN annotation 참조
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.ingress.annotations.alb\.ingress\.kubernetes\.io/certificate-arn }}
spec:
  ingressClassName: {{ .Values.ingress.className }}
  rules:
    - host: {{ .Values.ingress.hosts[0].host }}
      http:
        paths:
          # 루트 경로는 Apache 서비스로
          - path: {{ index .Values.ingress.hosts 0 "paths" 0 "path" }} # index 함수 사용 권장
            pathType: {{ index .Values.ingress.hosts 0 "paths" 0 "pathType" }}
            backend:
              service:
                name: {{ .Release.Name }}-apache-service
                port:
                  number: {{ .Values.apache.service.port }}
          # /api 경로는 Spring 서비스로
          - path: {{ index .Values.ingress.hosts 0 "paths" 1 "path" }} # 두 번째 경로
            pathType: {{ index .Values.ingress.hosts 0 "paths" 1 "pathType" }}
            backend:
              service:
                name: {{ .Release.Name }}-spring-service
                port:
                  # 수정된 values.yaml 구조에 맞게 참조 변경
                  number: {{ .Values.spring.service.port }}
